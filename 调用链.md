# 调用链
## 调用链监控的作用有哪些：

1. 项目网络拓扑图：

我们可以根据「调用链监控」中记录的链路信息，给项目生成一张网络调用的拓扑图。通过这张图，我们就可以知道系统中的各个服务之间的调用关系是怎样的，以及系统依赖了哪些服务。并且还可以起到监控全局服务的作用，便于架构师掌握系统的状态。


2. 快速定位问题：

这个作用前面一直在讲，微服务架构下，问题定位就变得非常复杂了，一个请求可能会经过多个服务节点，那么有这么一套调用链监控系统就能让开发人员快速的定位到问题和相应模块。


3. 优化系统：

优化系统也是「调用链监控」很重要的一个功能。因为我们记录了请求在调用链上每一个环节的信息，我们就可以通过这个来找出系统的瓶颈，做出针对性的优化。还可以分析这个调用路径是否合理，是否调用了不必要的服务节点，是否有更近、响应更快的服务节点。通过对调用链路的分析，我们就可以找出最优质的调用路径，从而提高系统的性能。


4. 提高团队成员自律：

上面都是系统层面的作用。但如果有了「调用链监控」之后，对团队开发人员的帮助也是非常大的。因为团队所有成员都可以通过这个调用链监控系统看到系统各个模块的状态，相当于给了开发同学一个放大镜，以前开发同学完成项目交付后，只要没有出现问题，可能不太关心系统的优化，但是有这个调用链监控系统之后，哪个模块性能高，哪个模块问题大，一眼就能分辨，通过这么一个看板，开发同学慢慢的也会对自己负责的模块有更多的责任感，也会很自觉的去优化自己的模块。这种习惯的养成，对研发团队而言，非常的重要。

## 调用链监控的原理
在调用链监控系统中，有几个核心概念需要了解：

- Trace:

Trace是指一次请求调用的链路过程，trace id 是指这次请求调用的ID。在一次请求中，会在网络的最开始生成一个全局唯一的用于标识此次请求的trace id，这个trace id在这次请求调用过程中无论经过多少个节点都会保持不变，并且在随着每一层的调用不停的传递。最终，可以通过trace id将这一次用户请求在系统中的路径全部串起来。


- Span:

Span是指一个模块的调用过程，一般用span id来标识。在一次请求的过程中会调用不同的节点/模块/服务，每一次调用都会生成一个新的span id来记录。这样，就可以通过span id来定位当前请求在整个系统调用链中所处的位置，以及它的上下游节点分别是什么。


•Annotation:

是指附属信息，可以用于附属在每一个Span上自定义的数据。

## opentracing
为了解决不同的分布式追踪系统 API 不兼容的问题，诞生了 OpenTracing 规范。
OpenTracing 是一个轻量级的标准化层，它位于应用程序/类库和追踪或日志分析程序之间。

span之间的references主要分为两种：
1. ChildOf references：
    1. parent span为客户端，child span为服务器。
    2. A Span representing a SQL insert may be the ChildOf a Span representing an ORM save method

2. FollowsFrom references: parent span不需要依赖child span，那么两者之间就是FollowsFrom references。

ChildOf references在时序图中两个span垂直分布。
FollowsFrom references在时序图中可以垂直分布，也可以错开分布。

## google dapper
全文详读[分布式追踪系统---google的dapper](https://blog.csdn.net/zhanlijun/article/details/13169771)

1. dapper日志记录格式
dapper用span来表示一个服务调用开始和结束的时间。dapper记录了span的名称以及每个span的ID和父ID，如果一个span没有父ID被称之为root span。所有的span都挂在一个特定得追踪上，共用一个跟踪ID，这些ID用全局64位整数标示。
2. 应用级透明
举个例子，几乎所有的google进程间通信是建立在一个用C++和JAVA开发的RPC框架上，dapper把跟踪植入这个框架，span的ID和跟踪的ID会从客户端发送到服务端，这样工程师也就不需要关心。
3. dapper跟踪收集过程
分为3个阶段：a）各个服务将span数据写到本机日志上；b）dapper守护进程进行拉取，将数据读到dapper收集器里；c）dapper收集器将结果写到bigtable中，一次跟踪被记录为一行。
![图片](https://img-blog.csdn.net/20131027143850218)
4. 降低开销
不对每一次的请求进行追踪收集，通过统计抽样的方法，抽样追踪一些请求，从而达到性能开销与精度的折中。
5，dapper的使用
- 监测新读物部署性能情况
- 推断服务间的依赖关系






